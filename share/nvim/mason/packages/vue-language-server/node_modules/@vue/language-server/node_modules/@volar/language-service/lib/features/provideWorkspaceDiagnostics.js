"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.register = void 0;
const common_1 = require("../utils/common");
const cancellation_1 = require("../utils/cancellation");
const vscode_uri_1 = require("vscode-uri");
const provideDiagnostics_1 = require("./provideDiagnostics");
const language_core_1 = require("@volar/language-core");
function register(context) {
    return async (token = cancellation_1.NoneCancellationToken) => {
        const allItems = [];
        for (const plugin of context.plugins) {
            if (context.disabledServicePlugins.has(plugin[1])) {
                continue;
            }
            if (token.isCancellationRequested) {
                break;
            }
            if (!plugin[1].provideWorkspaceDiagnostics) {
                continue;
            }
            const report = await plugin[1].provideWorkspaceDiagnostics(token);
            if (!report) {
                continue;
            }
            const items = report
                .map(item => {
                const decoded = context.decodeEmbeddedDocumentUri(vscode_uri_1.URI.parse(item.uri));
                const sourceScript = decoded && context.language.scripts.get(decoded[0]);
                const virtualCode = decoded && sourceScript?.generated?.embeddedCodes.get(decoded[1]);
                if (virtualCode && sourceScript) {
                    if (item.kind === 'unchanged') {
                        return {
                            ...item,
                            uri: sourceScript.id.toString(),
                        };
                    }
                    else {
                        const map = context.documents.getMap(virtualCode, sourceScript);
                        return {
                            ...item,
                            items: item.items
                                .map(error => (0, provideDiagnostics_1.transformDiagnostic)(context, error, map, language_core_1.shouldReportDiagnostics))
                                .filter(common_1.notEmpty)
                        };
                    }
                }
                else {
                    if (item.kind === 'unchanged') {
                        return item;
                    }
                    return {
                        ...item,
                        items: item.items
                            .map(error => (0, provideDiagnostics_1.transformDiagnostic)(context, error, undefined, language_core_1.shouldReportDiagnostics))
                            .filter(common_1.notEmpty)
                    };
                }
            });
            allItems.push(...items);
        }
        return allItems;
    };
}
exports.register = register;
//# sourceMappingURL=provideWorkspaceDiagnostics.js.map